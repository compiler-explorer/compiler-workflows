name: Install compiler(s)
run-name: Install ${{ inputs.compilers }}

on:
  workflow_dispatch:
    inputs:
      compilers:
        description: 'Compiler pattern to install (e.g., "clang hana-clang-trunk")'
        required: true
        type: string
      enable_nightly:
        description: 'Enable nightly builds'
        required: false
        type: boolean
        default: true
      force:
        description: 'Force install even if would otherwise skip'
        required: false
        type: boolean
        default: false

jobs:
  install:
    runs-on: ['self-hosted', 'ce', 'linux', 'x64']
    steps:
      - name: Start from a clean directory
        uses: AutoModality/action-clean@v1.1.0

      - name: Checkout infra repo
        uses: actions/checkout@v4
        with:
          repository: compiler-explorer/infra
          path: infra

      - name: Set up environment
        working-directory: infra
        run: make ce

      - name: Install compilers
        working-directory: infra
        run: |
          ENABLE_FLAG=""
          if [[ "${{ inputs.enable_nightly }}" == "true" ]]; then
            ENABLE_FLAG="--enable nightly"
          fi
          FORCE_FLAG=""
          if [[ "${{ inputs.force }}" == "true" ]]; then
            FORCE_FLAG="--force"
          fi
          sudo bin/ce_install --check-user nobody $ENABLE_FLAG install $FORCE_FLAG ${{ inputs.compilers }}
